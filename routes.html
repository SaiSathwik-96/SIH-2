<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Routes Result</title>
    <link rel="stylesheet" href="routes.css">
    <!-- Leaflet.js CDN for map display -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <a href="index.html" style="display:flex;align-items:center;text-decoration:none;color:inherit;gap:1rem;">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/bus.png" alt="Bus Icon" class="logo">
                <h1 style="margin:0;">HyderabadTransit</h1>
            </a>
        </div>
    </header>
    <main>
        <section class="planner-section">
            <div class="container">
                <div class="planner-header">
                    <img src="https://img.icons8.com/ios-filled/24/4e73df/route.png" alt="Route Icon">
                    <h2>Route Results</h2>
                </div>
                <div id="route-results">
                    <!-- Results will be rendered here -->
                </div>
            </div>
        </section>
        <section class="alerts-section">
            <div class="container">
                <h2>Service Alerts</h2>
                <div class="alerts-list" id="alerts-list">
                    <!-- Alerts will be rendered here -->
                </div>
            </div>
        </section>
        <section class="bus-location-section">
            <div class="container">
                <h2>Live Bus Location</h2>
                <!-- Modal for map -->
                <div id="busMapModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;">
                    <div style="background:#fff;padding:1.5rem;border-radius:12px;max-width:500px;width:90vw;position:relative;">
                        <button id="closeBusMapModal" style="position:absolute;top:10px;right:10px;background:#d9534f;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;cursor:pointer;">&times;</button>
                        <div id="bus-map" style="width:100%;height:300px;border-radius:12px;"></div>
                        <div id="bus-location-status" style="margin-top:1rem;"></div>
                    </div>
                </div>
            </div>
        </section>
        <section class="status-section">
            <div class="container">
                <h2>Real-time Status</h2>
                <div class="status-list" id="status-list">
                    <!-- Status will be rendered here -->
                </div>
                <div class="system-status" id="system-status">
                    <!-- System status will be rendered here -->
                </div>
            </div>
        </section>
    </main>
    <footer>
        <div class="container">
            <p>Powered by Telangana State Road Transport Corporation (TSRTC)</p>
            <p>Real-time data updated every 30 seconds • Covering Greater Hyderabad</p>
        </div>
    </footer>
    <script>
    // Live bus location fetch and map display
    function showBusLocationOnMap(route) {
        const mapDiv = document.getElementById('bus-map');
        const statusDiv = document.getElementById('bus-location-status');
        if (!route) {
            mapDiv.style.display = 'none';
            statusDiv.textContent = '';
            return;
        }
        fetch(`http://localhost:3000/api/bus-location?route=${encodeURIComponent(route)}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.lat && data.lng) {
                    mapDiv.style.display = 'block';
                    statusDiv.textContent = `Bus for route ${route} is currently here.`;
                    if (!window.busMap) {
                        window.busMap = L.map('bus-map').setView([data.lat, data.lng], 14);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(window.busMap);
                    } else {
                        window.busMap.setView([data.lat, data.lng], 14);
                        if (window.busMarker) window.busMap.removeLayer(window.busMarker);
                    }
                    window.busMarker = L.marker([data.lat, data.lng]).addTo(window.busMap);
                    window.busMarker.bindPopup(`Bus Location`).openPopup();
                } else {
                    mapDiv.style.display = 'none';
                    statusDiv.textContent = 'No live bus location available for this route.';
                }
            })
            .catch(() => {
                mapDiv.style.display = 'none';
                statusDiv.textContent = 'Could not fetch live bus location.';
            });
    }
    // Get query params
    function getQueryParams() {
        const params = {};
        window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str,key,value) {
            params[key] = decodeURIComponent(value);
        });
        return params;
    }
    const params = getQueryParams();
    let pickup = params.pickup || localStorage.getItem('userPickup') || '';
    let destination = params.destination || localStorage.getItem('userDestination') || '';
    const resultsDiv = document.getElementById('route-results');

    // Get bus details from localStorage (set by driver)
    function getDriverKey() {
        return localStorage.getItem('driverPhone') || sessionStorage.getItem('driverPhone');
    }
    function getDriverBusDetails() {
        const key = getDriverKey();
        if (key) {
            const data = localStorage.getItem('busDetails_' + key);
            return data ? JSON.parse(data) : null;
        }
        return null;
    }
    const driverBus = getDriverBusDetails() || {};

    if (pickup && destination) {
        let html = `<h3>Routes from <span style='color:#4e73df'>${pickup}</span> to <span style='color:#1cc88a'>${destination}</span></h3>`;
        html += '<div class="routes-list">';
        // Show the driver's bus if it matches the search by endpoints or by stops
        let showBus = false;
        let matchedPickup = '', matchedDest = '';
        if (
            driverBus.routeNumber && driverBus.routeFrom && driverBus.routeTo
        ) {
            // Direct endpoint match
            if (
                driverBus.routeFrom.toLowerCase().includes(pickup.toLowerCase()) &&
                driverBus.routeTo.toLowerCase().includes(destination.toLowerCase())
            ) {
                showBus = true;
                matchedPickup = driverBus.routeFrom;
                matchedDest = driverBus.routeTo;
            } else if (Array.isArray(driverBus.routeStops) && driverBus.routeStops.length > 0) {
                // Partial/substring and case-insensitive match for stops
                const stopsLower = driverBus.routeStops.map(s => s.toLowerCase());
                // Find first stop containing pickup
                let pickupIdx = -1, destIdx = -1;
                for (let i = 0; i < stopsLower.length; i++) {
                    if (stopsLower[i].includes(pickup.toLowerCase())) { pickupIdx = i; break; }
                }
                if (pickupIdx !== -1) {
                    for (let i = pickupIdx + 1; i < stopsLower.length; i++) {
                        if (stopsLower[i].includes(destination.toLowerCase())) { destIdx = i; break; }
                    }
                }
                if (pickupIdx !== -1 && destIdx !== -1 && pickupIdx < destIdx) {
                    showBus = true;
                    matchedPickup = driverBus.routeStops[pickupIdx];
                    matchedDest = driverBus.routeStops[destIdx];
                }
            }
        }
        if (showBus) {
            html += `<div class="route-card">
                <div class="route-info">
                    <span class="route-name">${driverBus.routeNumber}</span>
                    <span class="route-desc">${matchedPickup} - ${matchedDest}</span>
                </div>
                <div class="route-meta">
                    <span>Live</span>
                </div>
                <div class="route-price">Bus: <strong>${driverBus.busPlate}</strong></div>
                <button class="show-bus-location-btn" style="margin-top:0.5rem;background:#4e73df;color:#fff;border:none;padding:0.4rem 1rem;border-radius:5px;cursor:pointer;">Show Live Bus Location</button>
            </div>`;
        } else {
            html += '<div>No live buses found for this route.</div>';
        }
        html += '</div>';
        resultsDiv.innerHTML = html;
    } else {
        resultsDiv.innerHTML = '<p style="color:red">Invalid search. Please go back and enter both locations.</p>';
    }

    // Service Alerts (static sample)
    const alerts = [
        {
            icon: '⚠️',
            text: 'Route 100V experiencing 8-minute delays due to traffic near HITEC City',
            time: '3 min ago'
        },
        {
            icon: '🚌',
            text: 'Additional buses deployed on Route 216 for Diwali festival rush',
            time: '20 min ago'
        },
        {
            icon: '🚏',
            text: 'Bus stop at Ameerpet Metro temporarily shifted 50m ahead',
            time: '2 hours ago'
        }
    ];
    const alertsList = document.getElementById('alerts-list');
    if (alertsList) {
        alerts.forEach(alert => {
            const div = document.createElement('div');
            div.className = 'alert-card';
            div.innerHTML = `<span class="alert-icon">${alert.icon}</span><span class="alert-text">${alert.text}</span><span class="alert-time">${alert.time}</span>`;
            alertsList.appendChild(div);
        });
    }
    // Real-time Status (static sample)
    const statuses = [
        {
            route: '100V',
            status: '8 min delay',
            updated: 'Updated 45s ago',
            delay: true
        },
        {
            route: '216',
            status: 'On Time',
            updated: 'Updated 1m ago',
            delay: false
        },
        {
            route: '290U',
            status: 'On Time',
            updated: 'Updated 30s ago',
            delay: false
        },
        {
            route: '8A',
            status: '3 min delay',
            updated: 'Updated 2m ago',
            delay: true
        }
    ];
    const statusList = document.getElementById('status-list');
    if (statusList) {
        statuses.forEach(s => {
            const div = document.createElement('div');
            div.className = 'status-card';
            div.innerHTML = `<span class="route-name">${s.route}</span>` +
                `<span class="${s.delay ? 'status-delay' : 'status-ontime'}">${s.status}</span>` +
                `<span class="status-updated">${s.updated}</span>`;
            statusList.appendChild(div);
        });
    }
    const systemStatus = document.getElementById('system-status');
    if (systemStatus) {
        systemStatus.innerHTML = '<span>All Systems Operational</span><span>Last updated: Just now • Next update in 30s</span>';
    }

    // Add event listener for live location button
    setTimeout(function() {
        const btn = document.querySelector('.show-bus-location-btn');
        if (btn) {
            btn.addEventListener('click', function() {
                // Show modal
                const modal = document.getElementById('busMapModal');
                const mapDiv = document.getElementById('bus-map');
                const statusDiv = document.getElementById('bus-location-status');
                modal.style.display = 'flex';
                // Remove previous map instance if any
                if (window.busMap) {
                    window.busMap.remove();
                    window.busMap = null;
                }
                statusDiv.textContent = 'Fetching live bus location...';
                fetch(`https://rootmatelocations.onrender.com/busstatus/${encodeURIComponent(driverBus.busPlate)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.LATITUDE && data.LONGITUDE) {
                            window.busMap = L.map('bus-map').setView([data.LATITUDE, data.LONGITUDE], 14);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(window.busMap);
                            window.busMarker = L.marker([data.LATITUDE, data.LONGITUDE]).addTo(window.busMap);
                            window.busMarker.bindPopup(`Bus Location`).openPopup();
                            statusDiv.textContent = `Bus is currently at latitude ${data.LATITUDE}, longitude ${data.LONGITUDE}.`;
                        } else {
                            mapDiv.innerHTML = '';
                            statusDiv.textContent = 'No live bus location available.';
                        }
                    })
                    .catch(() => {
                        mapDiv.innerHTML = '';
                        statusDiv.textContent = 'Could not fetch live bus location.';
                    });
                // Close modal logic
                document.getElementById('closeBusMapModal').onclick = function() {
                    modal.style.display = 'none';
                    if (window.busMap) {
                        window.busMap.remove();
                        window.busMap = null;
                    }
                };
            });
        }
    }, 0);
    </script>
</body>
</html>

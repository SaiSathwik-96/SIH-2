
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Routes Result</title>
    <link rel="stylesheet" href="routes.css">
    <!-- Leaflet.js CDN for map display -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <a href="index.html" style="display:flex;align-items:center;text-decoration:none;color:inherit;gap:1rem;">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/bus.png" alt="Bus Icon" class="logo">
                <h1 style="margin:0;">HyderabadTransit</h1>
            </a>
        </div>
    </header>
    <main>
        <section class="planner-section">
            <div class="container">
                <div class="planner-header">
                    <img src="https://img.icons8.com/ios-filled/24/4e73df/route.png" alt="Route Icon">
                    <h2>Route Results</h2>
                </div>
                <div id="route-results">
                    <!-- Results will be rendered here -->
                </div>
            </div>
        </section>
        <section class="alerts-section">
            <div class="container">
                <h2>Service Alerts</h2>
                <div class="alerts-list" id="alerts-list">
                    <!-- Alerts will be rendered here -->
                </div>
            </div>
        </section>
        <section class="bus-location-section">
            <div class="container">
                <h2>Live Bus Location</h2>
                <div id="bus-map" style="width:100%;height:300px;border-radius:12px;margin-bottom:1rem;display:none;"></div>
                <div id="bus-location-status"></div>
            </div>
        </section>
        <section class="status-section">
            <div class="container">
                <h2>Real-time Status</h2>
                <div class="status-list" id="status-list">
                    <!-- Status will be rendered here -->
                </div>
                <div class="system-status" id="system-status">
                    <!-- System status will be rendered here -->
                </div>
            </div>
        </section>
    </main>
    <footer>
        <div class="container">
            <p>Powered by Telangana State Road Transport Corporation (TSRTC)</p>
            <p>Real-time data updated every 30 seconds â€¢ Covering Greater Hyderabad</p>
        </div>
    </footer>
    <script>
    // Live bus location fetch and map display
    function showBusLocationOnMap(route) {
        const mapDiv = document.getElementById('bus-map');
        const statusDiv = document.getElementById('bus-location-status');
        if (!route) {
            mapDiv.style.display = 'none';
            statusDiv.textContent = '';
            return;
        }
        fetch(`http://localhost:3000/api/bus-location?route=${encodeURIComponent(route)}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.lat && data.lng) {
                    mapDiv.style.display = 'block';
                    statusDiv.textContent = `Bus for route ${route} is currently here.`;
                    if (!window.busMap) {
                        window.busMap = L.map('bus-map').setView([data.lat, data.lng], 14);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(window.busMap);
                    } else {
                        window.busMap.setView([data.lat, data.lng], 14);
                        if (window.busMarker) window.busMap.removeLayer(window.busMarker);
                    }
                    window.busMarker = L.marker([data.lat, data.lng]).addTo(window.busMap);
                    window.busMarker.bindPopup(`Bus Location`).openPopup();
                } else {
                    mapDiv.style.display = 'none';
                    statusDiv.textContent = 'No live bus location available for this route.';
                }
            })
            .catch(() => {
                mapDiv.style.display = 'none';
                statusDiv.textContent = 'Could not fetch live bus location.';
            });
    }
    // Get query params
    function getQueryParams() {
        const params = {};
        window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str,key,value) {
            params[key] = decodeURIComponent(value);
        });
        return params;
    }
    const params = getQueryParams();
    const pickup = params.pickup || '';
    const destination = params.destination || '';
    const resultsDiv = document.getElementById('route-results');
    if (pickup && destination) {
        // Sample route data
        const sampleRoutes = [
            {
                route: '100V',
                from: 'Secunderabad',
                to: 'HITEC City',
                price: 'â‚¹35',
                duration: '45 min',
                frequency: 'Every 8 min'
            },
            {
                route: '216',
                from: 'Mehdipatnam',
                to: 'Gachibowli',
                price: 'â‚¹30',
                duration: '35 min',
                frequency: 'Every 12 min'
            },
            {
                route: '290U',
                from: 'JBS',
                to: 'Kondapur',
                price: 'â‚¹40',
                duration: '50 min',
                frequency: 'Every 10 min'
            },
            {
                route: '8A',
                from: 'Charminar',
                to: 'Begumpet',
                price: 'â‚¹28',
                duration: '40 min',
                frequency: 'Every 15 min'
            }
        ];
        let html = `<h3>Routes from <span style='color:#4e73df'>${pickup}</span> to <span style='color:#1cc88a'>${destination}</span></h3>`;
        html += '<div class="routes-list">';
        sampleRoutes.forEach(r => {
            html += `<div class="route-card">
                <div class="route-info">
                    <span class="route-name">${r.route}</span>
                    <span class="route-desc">${r.from} - ${r.to}</span>
                </div>
                <div class="route-meta">
                    <span>${r.duration}</span>
                    <span>${r.frequency}</span>
                </div>
                <div class="route-price">Price: <strong>${r.price}</strong></div>
                <button class="show-bus-location-btn" data-route="${r.route}" style="margin-top:0.5rem;background:#4e73df;color:#fff;border:none;padding:0.4rem 1rem;border-radius:5px;cursor:pointer;">Show Live Bus Location</button>
            </div>`;
        });
        html += '</div>';
        resultsDiv.innerHTML = html;
        // Add event listeners to show bus location buttons
        document.querySelectorAll('.show-bus-location-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                showBusLocationOnMap(this.getAttribute('data-route'));
            });
        });
    } else {
        resultsDiv.innerHTML = '<p style="color:red">Invalid search. Please go back and enter both locations.</p>';
    }

    // Service Alerts (static sample)
    const alerts = [
        {
            icon: 'âš ï¸',
            text: 'Route 100V experiencing 8-minute delays due to traffic near HITEC City',
            time: '3 min ago'
        },
        {
            icon: 'ðŸšŒ',
            text: 'Additional buses deployed on Route 216 for Diwali festival rush',
            time: '20 min ago'
        },
        {
            icon: 'ðŸš',
            text: 'Bus stop at Ameerpet Metro temporarily shifted 50m ahead',
            time: '2 hours ago'
        }
    ];
    const alertsList = document.getElementById('alerts-list');
    if (alertsList) {
        alerts.forEach(alert => {
            const div = document.createElement('div');
            div.className = 'alert-card';
            div.innerHTML = `<span class="alert-icon">${alert.icon}</span><span class="alert-text">${alert.text}</span><span class="alert-time">${alert.time}</span>`;
            alertsList.appendChild(div);
        });
    }
    // Real-time Status (static sample)
    const statuses = [
        {
            route: '100V',
            status: '8 min delay',
            updated: 'Updated 45s ago',
            delay: true
        },
        {
            route: '216',
            status: 'On Time',
            updated: 'Updated 1m ago',
            delay: false
        },
        {
            route: '290U',
            status: 'On Time',
            updated: 'Updated 30s ago',
            delay: false
        },
        {
            route: '8A',
            status: '3 min delay',
            updated: 'Updated 2m ago',
            delay: true
        }
    ];
    const statusList = document.getElementById('status-list');
    if (statusList) {
        statuses.forEach(s => {
            const div = document.createElement('div');
            div.className = 'status-card';
            div.innerHTML = `<span class="route-name">${s.route}</span>` +
                `<span class="${s.delay ? 'status-delay' : 'status-ontime'}">${s.status}</span>` +
                `<span class="status-updated">${s.updated}</span>`;
            statusList.appendChild(div);
        });
    }
    const systemStatus = document.getElementById('system-status');
    if (systemStatus) {
        systemStatus.innerHTML = '<span>All Systems Operational</span><span>Last updated: Just now â€¢ Next update in 30s</span>';
    }
    </script>
</body>
</html>
